{"version":3,"sources":["../../src/controllers/contourMap_ctrl.js"],"names":["MetricsPanelCtrl","_","d3","moment","L","TileServers","StatesData","isobands","ContourMapCtrl","$scope","$injector","ctrl","events","on","onInitEditMode","bind","onPanelTeardown","onRender","onPanelInitialized","onDataRecieved","onDataError","onRefresh","panel","tileServer","undefined","maxZoom","Options","options","minZoom","zoomLevel","lockMap","maxLongitude","maxLatitude","minLatitude","minLongitude","useReferenceValue","referencePointTag","useAngleMean","angleMeanTimeWindow","showLegend","showWeather","useGradient","gradientBreakCount","gradientStart","gradientEnd","gradientStartColor","gradientEndColor","gradientSigFigs","ySteps","xSteps","distancePower","overlap","data","circleMarkers","contourLayers","mapContainer","legend","stateSvg","addEditorTab","map","off","height","row","render","console","log","createMap","plotContourWithD3","msg","scope","elem","attr","$panelContainer","find","mapOptions","zoomControl","attributionControl","boxZoom","doubleClickZoom","dragging","zoomDelta","id","tileLayer","url","addTo","updateMapView","event","getZoom","bounds","getBounds","_southWest","lng","_northEast","lat","geojsonMarkerOptions","radius","stroke","color","weight","opacity","lineCap","lineJoin","dashArray","dashOffset","fill","fillColor","fillOpacity","fillRule","bubblingMouseEvents","renderer","className","removeFrom","length","geoJson","createGeoJson","isoband","properties","breaks","addLegend","each","e","i","l","geojsonFeature","rootTarget","datapoints","longitude","latitude","features","push","geoJSON","style","feature","pointToLayer","latlng","circleMarker","onEachFeature","layer","popupContent","bindPopup","date","remainder","minute","add","utc","format","ia_wms","remove","wms","layers","transparent","time","stateData","geoPath","geometry","div","select","empty","svg","getPanes","overlayPane","append","g","transform","geoTransform","point","projectPoint","path","projection","clipPath","fakemask","mask","selectAll","enter","d","circles","latLngToLayerPoint","LatLng","x","y","transition","duration","html","toFixed","pageX","pageY","topLeft","bottomRight","reset","stream","control","position","onAdd","DomUtil","create","labels","a","Value","colors","innerHTML","setZoom","fitBounds","markerGroup","featureGroup","isValid","min","max","step","input","minLng","minLat","maxLng","maxLat","overlapLat","overlapLng","gridN","gridM","pow","nStep","Math","abs","mStep","scaleLinear","domain","range","interpolate","interpolateCubehelixLong","styles","j","wzSum","wSum","element","index","list","val","isNaN","getDistanceFromLatLonInKm","value","lat1","lon1","lat2","lon2","R","dLat","deg2rad","dLon","sin","cos","c","atan2","sqrt","deg","PI","templateUrl"],"mappings":"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","file":"contourMap_ctrl.js","sourcesContent":["﻿//******************************************************************************************************\r\n//  contourMap_ctrl.ts - Gbtc\r\n//\r\n//  Copyright © 2017, Grid Protection Alliance.  All Rights Reserved.\r\n//\r\n//  Licensed to the Grid Protection Alliance (GPA) under one or more contributor license agreements. See\r\n//  the NOTICE file distributed with this work for additional information regarding copyright ownership.\r\n//  The GPA licenses this file to you under the MIT License (MIT), the \"License\"; you may not use this\r\n//  file except in compliance with the License. You may obtain a copy of the License at:\r\n//\r\n//      http://opensource.org/licenses/MIT\r\n//\r\n//  Unless agreed to in writing, the subject software distributed under the License is distributed on an\r\n//  \"AS-IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. Refer to the\r\n//  License for the specific language governing permissions and limitations.\r\n//\r\n//  Code Modification History:\r\n//  ----------------------------------------------------------------------------------------------------\r\n//  11/08/2017 - Billy Ernest\r\n//       Generated original version of source code.\r\n//\r\n//******************************************************************************************************\r\n\r\nimport { MetricsPanelCtrl } from 'app/plugins/sdk'\r\n\r\nimport _ from 'lodash';\r\nimport d3 from \"d3\";\r\nimport moment from \"moment\";\r\n\r\nimport * as L from 'leaflet';\r\nimport './../css/leaflet.css!';\r\n\r\nimport { TileServers, StatesData } from './../js/constants';\r\nimport isobands from \"@turf/isobands\"\r\n\r\nexport class ContourMapCtrl extends MetricsPanelCtrl {\r\n    constructor($scope, $injector) {\r\n        super($scope, $injector);\r\n\r\n        var ctrl = this;\r\n\r\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n        this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\r\n        this.events.on('render', this.onRender.bind(this));\r\n        this.events.on('panel-initialized', this.onPanelInitialized.bind(this));\r\n        this.events.on('data-received', this.onDataRecieved.bind(this));\r\n        //this.events.on('data-snapshot-load', console.log('data-snapshot-load'));\r\n        this.events.on('data-error', this.onDataError.bind(this));\r\n        this.events.on('refresh', this.onRefresh.bind(this));\r\n\r\n\r\n        // Variables for options\r\n        ctrl.TileServers = TileServers;\r\n        ctrl.panel.tileServer = (ctrl.panel.tileServer != undefined ? ctrl.panel.tileServer: TileServers[0]);\r\n        ctrl.panel.maxZoom = (ctrl.panel.tileServer.Options.options.maxZoom != undefined ? ctrl.panel.tileServer.Options.options.maxZoom : 18)\r\n        ctrl.panel.minZoom = (ctrl.panel.tileServer.Options.options.minZoom != undefined ? ctrl.panel.tileServer.Options.options.minZoom : 2)\r\n        ctrl.panel.zoomLevel = (ctrl.panel.zoomLevel != undefined ? ctrl.panel.zoomLevel : ctrl.panel.tileServer.Options.options.maxZoom);\r\n        ctrl.panel.lockMap = (ctrl.panel.lockMap != undefined ? ctrl.panel.lockMap : 'No');\r\n        ctrl.panel.maxLongitude = (ctrl.panel.maxLongitude != undefined ? ctrl.panel.maxLongitude : -125);\r\n        ctrl.panel.maxLatitude = (ctrl.panel.maxLatitude != undefined ? ctrl.panel.maxLatitude : 24);\r\n        ctrl.panel.minLatitude = (ctrl.panel.minLatitude != undefined ? ctrl.panel.minLatitude : 50);\r\n        ctrl.panel.minLongitude = (ctrl.panel.minLongitude != undefined ? ctrl.panel.minLongitude : -66);\r\n        ctrl.panel.useReferenceValue = (ctrl.panel.useReferenceValue != undefined ? ctrl.panel.useReferenceValue : false);\r\n        ctrl.panel.referencePointTag = (ctrl.panel.referencePointTag != undefined ? ctrl.panel.referencePointTag : '');\r\n        ctrl.panel.useAngleMean = (ctrl.panel.useAngleMean != undefined ? ctrl.panel.useAngleMean : false);\r\n        ctrl.panel.angleMeanTimeWindow = (ctrl.panel.angleMeanTimeWindow != undefined ? ctrl.panel.angleMeanTimeWindow : '5');\r\n        ctrl.panel.showLegend = (ctrl.panel.showLegend != undefined ? ctrl.panel.showLegend : false);\r\n        ctrl.panel.showWeather = (ctrl.panel.showWeather != undefined ? ctrl.panel.showWeather : false);\r\n\r\n        ctrl.panel.useGradient = (ctrl.panel.useGradient != undefined ? ctrl.panel.useGradient : true);\r\n        ctrl.panel.gradientBreakCount = (ctrl.panel.gradientBreakCount != undefined ? ctrl.panel.gradientBreakCount : 10);\r\n        ctrl.panel.gradientStart = (ctrl.panel.gradientStart != undefined ? ctrl.panel.gradientStart : 0);\r\n        ctrl.panel.gradientEnd = (ctrl.panel.gradientEnd != undefined ? ctrl.panel.gradientEnd : 1000);\r\n        ctrl.panel.gradientStartColor = (ctrl.panel.gradientStartColor != undefined ? ctrl.panel.gradientStartColor : 'purple');\r\n        ctrl.panel.gradientEndColor = (ctrl.panel.gradientEndColor != undefined ? ctrl.panel.gradientEndColor : 'red');\r\n        ctrl.panel.gradientSigFigs = (ctrl.panel.gradientSigFigs != undefined ? ctrl.panel.gradientSigFigs : 2);\r\n\r\n        ctrl.panel.ySteps = (ctrl.panel.ySteps != undefined ? ctrl.panel.ySteps : 25);\r\n        ctrl.panel.xSteps = (ctrl.panel.xSteps != undefined ? ctrl.panel.xSteps : 35);\r\n        ctrl.panel.distancePower = (ctrl.panel.distancePower != undefined ? ctrl.panel.distancePower : 2);\r\n        ctrl.panel.overlap = (ctrl.panel.overlap != undefined ? ctrl.panel.overlap : 0);\r\n\r\n        ctrl.data = [];\r\n        ctrl.circleMarkers = [];\r\n        ctrl.contourLayers = null;\r\n        ctrl.$scope.mapContainer == null;\r\n        ctrl.legend = null;\r\n        ctrl.stateSvg = null;\r\n\r\n\r\n    }\r\n\r\n    // #region Events from Graphana Handlers\r\n    onInitEditMode() {\r\n        this.addEditorTab('Options', 'public/plugins/gridprotectionalliance-contourmap-panel/partials/editor.html', 2);\r\n        this.addEditorTab('Colors', 'public/plugins/gridprotectionalliance-contourmap-panel/partials/colors.html', 3);\r\n        //console.log('init-edit-mode');\r\n    }\r\n\r\n    onPanelTeardown() {\r\n        if (this.map) {\r\n            this.map.off('zoomend');\r\n            this.map.off('moveend');\r\n        }\r\n        //console.log('panel-teardown');\r\n    }\r\n\r\n    onPanelInitialized() {\r\n        //console.log('panel-initialized');\r\n    }\r\n\r\n    onRefresh() {\r\n        var ctrl = this;\r\n\r\n        if (ctrl.height > ctrl.row.height) ctrl.render();\r\n\r\n        //console.log('refresh');\r\n    }\r\n\r\n    onResize() {\r\n        var ctrl = this;\r\n        //console.log('refresh');\r\n    }\r\n\r\n    onRender() {\r\n        console.log('render');\r\n\r\n    }\r\n\r\n    onDataRecieved(data) {\r\n        var ctrl = this;\r\n        ctrl.data = data;\r\n\r\n        if (ctrl.$scope.mapContainer == null) ctrl.createMap();\r\n        ctrl.plotContourWithD3(data);\r\n    }\r\n\r\n    onDataError(msg) {\r\n        //console.log('data-error');\r\n    }\r\n\r\n    // ran on dom creation\r\n    link(scope, elem, attr, ctrl) {\r\n        ctrl.$panelContainer = elem.find('.panel-container');\r\n        ctrl.panel.height = ctrl.height;\r\n        \r\n    } \r\n    // #endregion\r\n\r\n    // #region Map and Marker Creation\r\n    createMap() {\r\n        var ctrl = this;\r\n\r\n        if (ctrl.$scope.mapContainer == null) {\r\n\r\n            var mapOptions = {\r\n                zoomControl: false,\r\n                attributionControl: false,\r\n                boxZoom: false,\r\n                doubleClickZoom: false,\r\n                dragging: (ctrl.panel.lockMap == 'No'),\r\n                zoomDelta: (ctrl.panel.lockMap == 'No' ? 1 : 0),\r\n                minZoom: (ctrl.panel.lockMap == 'No' ? ctrl.panel.minZoom : ctrl.panel.zoomLevel),\r\n                maxZoom: (ctrl.panel.lockMap == 'No' ? ctrl.panel.maxZoom : ctrl.panel.zoomLevel)\r\n            };\r\n\r\n            ctrl.$scope.mapContainer = L.map('mapid_' + ctrl.panel.id, mapOptions);\r\n            ctrl.$scope.tileLayer = L.tileLayer(ctrl.panel.tileServer.Options.url, ctrl.panel.tileServer.Options.options);\r\n            ctrl.$scope.tileLayer.addTo(ctrl.$scope.mapContainer);\r\n            ctrl.updateMapView();\r\n\r\n            // setup map listeners\r\n            ctrl.$scope.mapContainer.off('zoomend');\r\n            ctrl.$scope.mapContainer.on('zoomend', function (event) {\r\n                ctrl.panel.zoomLevel = ctrl.$scope.mapContainer.getZoom();\r\n\r\n                var bounds = ctrl.$scope.mapContainer.getBounds();\r\n                ctrl.panel.maxLongitude = bounds._southWest.lng;\r\n                ctrl.panel.maxLatitude = bounds._northEast.lat;\r\n                ctrl.panel.minLatitude = bounds._southWest.lat;\r\n                ctrl.panel.minLongitude = bounds._northEast.lng;\r\n                //ctrl.refresh();\r\n                ctrl.plotContourWithD3(ctrl.data)\r\n            });\r\n            ctrl.$scope.mapContainer.off('moveend');\r\n            ctrl.$scope.mapContainer.on('moveend', function (event) {\r\n                ctrl.panel.zoomLevel = ctrl.$scope.mapContainer.getZoom();\r\n\r\n                var bounds = ctrl.$scope.mapContainer.getBounds();\r\n                ctrl.panel.maxLongitude = bounds._southWest.lng;\r\n                ctrl.panel.maxLatitude = bounds._northEast.lat;\r\n                ctrl.panel.minLatitude = bounds._southWest.lat;\r\n                ctrl.panel.minLongitude = bounds._northEast.lng;\r\n                //ctrl.refresh();\r\n                ctrl.plotContourWithD3(ctrl.data)\r\n            });\r\n            ctrl.$scope.mapContainer.on(\"viewreset\", ctrl.plotContourWithD3(ctrl.data));\r\n\r\n        }\r\n    }\r\n\r\n    plotContour(data) {\r\n        var geojsonMarkerOptions = {\r\n            radius: 4,             // Radius of the circle marker, in pixels\r\n            stroke: true,           // Whether to draw stroke along the path. Set it to false to disable borders on polygons or circles.\r\n            color: '#3388ff',       // Stroke color\r\n            weight: 1,              // Stroke width in pixels\r\n            opacity: 1.0,           // Stroke opacity\r\n            lineCap: 'round',       // A string that defines shape to be used at the end of the stroke.\r\n            lineJoin: 'round',      // A string that defines shape to be used at the corners of the stroke.\r\n            dashArray: null,        // A string that defines the stroke dash pattern. Doesn't work on Canvas-powered layers in some old browsers.\r\n            dashOffset: null,       // A string that defines the distance into the dash pattern to start the dash. Doesn't work on Canvas-powered layers in some old browsers.\r\n            fill: true,             // Whether to fill the path with color. Set it to false to disable filling on polygons or circles.\r\n            fillColor: '#3388ff',   // Fill color. Defaults to the value of the color option\r\n            fillOpacity: 0.2,       // Fill opacity.\r\n            fillRule: 'evenodd',    // A string that defines how the inside of a shape is determined.\r\n            bubblingMouseEvents: true,  // When true, a mouse event on this path will trigger the same event on the map (unless L.DomEvent.stopPropagation is used).\r\n            renderer: null,         // Use this specific instance of Renderer for this path. Takes precedence over the map's default renderer.\r\n            className: null         // \tCustom class name set on an element. Only for SVG renderer.\r\n        };\r\n\r\n        var ctrl = this;\r\n\r\n        if (ctrl.contourLayers != null) ctrl.contourLayers.removeFrom(ctrl.$scope.mapContainer);\r\n\r\n        if (data.length < 2) return;\r\n\r\n        var geoJson = this.createGeoJson(data);\r\n        var isoband = isobands(geoJson, geoJson.properties.breaks, geoJson.properties);\r\n\r\n        ctrl.addLegend(isoband);\r\n\r\n        _.each(data, (e, i, l) => {\r\n            var geojsonFeature = {\r\n                \"type\": \"Feature\",\r\n                \"properties\": {\r\n                    \"name\": e.rootTarget,\r\n                    \"popupContent\": e.rootTarget + '-' + (e.datapoints.length > 0 ? e.datapoints[e.datapoints.length - 1][0] : \"No Data\")\r\n                },\r\n                \"geometry\": {\r\n                    \"type\": \"Point\",\r\n                    \"coordinates\": [e.longitude, e.latitude]\r\n                }\r\n            };\r\n\r\n            isoband.features.push(geojsonFeature);\r\n        });\r\n\r\n        ctrl.contourLayers = L.geoJSON(isoband, {\r\n            style: function (feature) {\r\n                return feature.properties.style\r\n            },\r\n            pointToLayer: function (feature, latlng) {\r\n                return L.circleMarker(latlng, geojsonMarkerOptions);\r\n            },\r\n            onEachFeature: function (feature, layer) {\r\n                if (feature.properties && feature.properties.popupContent) {\r\n                    layer.bindPopup(feature.properties.popupContent);\r\n                }\r\n            }\r\n        }).addTo(ctrl.$scope.mapContainer);\r\n\r\n\r\n        var date = (data[0].datapoints.length > 0 ? moment(data[0].datapoints[data[0].datapoints.length - 1][1]) : moment());\r\n        var remainder = date.minute() % 5;\r\n        date = moment(date).add(-remainder, \"minutes\").utc().format(\"YYYY-MM-DDTHH:mm\");\r\n\r\n        if (ctrl.ia_wms != null) ctrl.ia_wms.remove();\r\n\r\n        if(ctrl.panel.showWeather)\r\n            ctrl.ia_wms = L.tileLayer.wms(\"https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r-t.cgi?\", { layers: \"nexrad-n0r-wmst\", transparent: true, format: 'image/png', time: date}).addTo(ctrl.$scope.mapContainer);\r\n\r\n    }\r\n\r\n    plotContourWithD3(data) {\r\n        var ctrl = this;\r\n        var geoJson = this.createGeoJson(data);\r\n        var isoband = isobands(geoJson, geoJson.properties.breaks, geoJson.properties);\r\n        var stateData = d3.geoPath()(StatesData.features[4].geometry)\r\n        // Define the div for the tooltip\r\n        var div = d3.select(\"#tooltip_\" + ctrl.panel.id);\r\n\r\n        if (!d3.select('#mapid_' + ctrl.panel.id + ' .leaflet-overlay-pane svg').empty()) d3.select('#mapid_' + ctrl.panel.id + ' .leaflet-overlay-pane svg').remove();\r\n        var svg = d3.select(ctrl.$scope.mapContainer.getPanes().overlayPane).append(\"svg\"),\r\n            g = svg.append(\"g\").attr(\"class\", \"leaflet-zoom-hide\").attr(\"clip-path\",\"url(#mask)\"),\r\n            transform = d3.geoTransform({ point: projectPoint }),\r\n            path = d3.geoPath().projection(transform),\r\n            clipPath = svg.append('defs').append('clipPath').attr('id', 'mask'),\r\n            fakemask = g.append(\"path\").style('stroke','black').style('fill-opacity', '0'),\r\n            mask = clipPath.append(\"path\");\r\n\r\n        ctrl.addLegend(isoband);\r\n\r\n\r\n        // create isobands\r\n        var feature = g.selectAll(\"path\")\r\n            .data(isoband.features)\r\n            .enter()\r\n            .append(\"path\")\r\n            .style(\"fill\", function (d) { return d.properties.style.fillColor })\r\n            .style(\"opacity\", function (d) { return 0.5 });\r\n\r\n        // create markers\r\n        var circles = g.selectAll(\"circle\")\r\n            .data(data)\r\n            .enter()\r\n            .append(\"circle\")\r\n            .attr(\"cx\", function (d) { return ctrl.$scope.mapContainer.latLngToLayerPoint(new L.LatLng(d.latitude, d.longitude)).x })\r\n            .attr(\"cy\", function (d) { return ctrl.$scope.mapContainer.latLngToLayerPoint(new L.LatLng(d.latitude, d.longitude)).y })\r\n            .attr(\"r\", \"4px\")\r\n            .attr(\"fill\", \"#3388ff\")\r\n            .attr(\"opacity\", \"1.0\")\r\n            .attr(\"fill-opacity\", \"0.2\")\r\n            .attr(\"fill-rule\", \"evenodd\")\r\n            .attr(\"weight\", \"1\")\r\n            .attr(\"stroke\", true)\r\n            .attr(\"cursor\", \"pointer\")\r\n            .on(\"mouseover\", function (d) {\r\n                div.transition()\r\n                    .duration(200)\r\n                    .style(\"opacity\", 1);\r\n                div.html(d.rootTarget + \"<br/>\" + (d.datapoints.length > 0 ? d.datapoints[d.datapoints.length - 1][0].toFixed(4) : \"No Data\"))\r\n                    .style(\"left\", (event.pageX) + \"px\")\r\n                    .style(\"top\", (event.pageY - 100) + \"px\");\r\n            })\r\n            .on(\"mouseout\", function (d) {\r\n                div.transition()\r\n                    .duration(500)\r\n                    .style(\"opacity\", 0);\r\n            });\r\n\r\n\r\n        var geojsonMarkerOptions = {\r\n            radius: 4,             // Radius of the circle marker, in pixels\r\n            stroke: true,           // Whether to draw stroke along the path. Set it to false to disable borders on polygons or circles.\r\n            color: '#3388ff',       // Stroke color\r\n            weight: 1,              // Stroke width in pixels\r\n            opacity: 1.0,           // Stroke opacity\r\n            lineCap: 'round',       // A string that defines shape to be used at the end of the stroke.\r\n            lineJoin: 'round',      // A string that defines shape to be used at the corners of the stroke.\r\n            dashArray: null,        // A string that defines the stroke dash pattern. Doesn't work on Canvas-powered layers in some old browsers.\r\n            dashOffset: null,       // A string that defines the distance into the dash pattern to start the dash. Doesn't work on Canvas-powered layers in some old browsers.\r\n            fill: true,             // Whether to fill the path with color. Set it to false to disable filling on polygons or circles.\r\n            fillColor: '#3388ff',   // Fill color. Defaults to the value of the color option\r\n            fillOpacity: 0.2,       // Fill opacity.\r\n            fillRule: 'evenodd',    // A string that defines how the inside of a shape is determined.\r\n            bubblingMouseEvents: true,  // When true, a mouse event on this path will trigger the same event on the map (unless L.DomEvent.stopPropagation is used).\r\n            renderer: null,         // Use this specific instance of Renderer for this path. Takes precedence over the map's default renderer.\r\n            className: null         // \tCustom class name set on an element. Only for SVG renderer.\r\n        };\r\n\r\n        var bounds = path.bounds(isoband),\r\n            topLeft = bounds[0],\r\n            bottomRight = bounds[1];\r\n\r\n        svg.attr(\"width\", bottomRight[0] - topLeft[0])\r\n            .attr(\"height\", bottomRight[1] - topLeft[1])\r\n            .style(\"left\", topLeft[0] + \"px\")\r\n            .style(\"top\", topLeft[1] + \"px\");\r\n\r\n        feature.attr(\"transform\", \"translate(\" + -topLeft[0] + \",\" + -topLeft[1] + \")\");\r\n        feature.attr(\"d\", path);\r\n        circles.attr(\"transform\", \"translate(\" + -topLeft[0] + \",\" + -topLeft[1] + \")\");\r\n        mask.attr(\"transform\", \"translate(\" + -topLeft[0] + \",\" + -topLeft[1] + \")\");\r\n        mask.attr(\"d\", path(StatesData.features[4]));\r\n\r\n\r\n        var date = (data[0].datapoints.length > 0 ? moment(data[0].datapoints[data[0].datapoints.length - 1][1]) : moment());\r\n        var remainder = date.minute() % 5;\r\n        date = moment(date).add(-remainder, \"minutes\").utc().format(\"YYYY-MM-DDTHH:mm\");\r\n\r\n        if (ctrl.ia_wms != null) ctrl.ia_wms.remove();\r\n\r\n        if (ctrl.panel.showWeather)\r\n            ctrl.ia_wms = L.tileLayer.wms(\"https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r-t.cgi?\", { layers: \"nexrad-n0r-wmst\", transparent: true, format: 'image/png', time: date }).addTo(ctrl.$scope.mapContainer);\r\n\r\n        // Reposition the SVG to cover the features.\r\n        function reset() {\r\n\r\n        }\r\n\r\n\r\n        function projectPoint(x, y) {\r\n            var point = ctrl.$scope.mapContainer.latLngToLayerPoint(new L.LatLng(y, x));\r\n            this.stream.point(point.x, point.y);\r\n        }\r\n    }\r\n\r\n    addLegend(data) {\r\n        var ctrl = this;\r\n\r\n        if (ctrl.legend != null)\r\n            ctrl.legend.remove();\r\n\r\n        if (ctrl.panel.showLegend) {\r\n            ctrl.legend = L.control({ position: 'bottomright' });\r\n\r\n            ctrl.legend.onAdd = function (map) {\r\n\r\n                var div = L.DomUtil.create('div', 'info legend'),\r\n                    labels = data.features.map(a => { return a.properties.Value }),\r\n                    colors = data.features.map(a => { return a.properties.style.fillColor });\r\n\r\n                // loop through our density intervals and generate a label with a colored square for each interval\r\n                for (var i = 1; i < labels.length; i++) {\r\n                    div.innerHTML +=\r\n                        '<i style=\"background:' + colors[i] + '\"></i> ' +\r\n                        labels[i] + '<br>';\r\n                }\r\n\r\n                return div;\r\n            };\r\n\r\n            ctrl.legend.addTo(ctrl.$scope.mapContainer);\r\n        }\r\n    }\r\n    // #endregion\r\n\r\n    // #region Options Functions\r\n    changeMapBackground() {\r\n        var ctrl = this;\r\n\r\n        ctrl.$scope.tileLayer.remove();\r\n        ctrl.$scope.tileLayer = L.tileLayer(ctrl.panel.tileServer.Options.url, ctrl.panel.tileServer.Options.options);\r\n        ctrl.$scope.tileLayer.addTo(this.$scope.mapContainer);\r\n    }\r\n\r\n    updateZoom() {\r\n        var ctrl = this;\r\n\r\n        ctrl.$scope.mapContainer.options.minZoom = (ctrl.panel.lockMap == 'No' ? ctrl.panel.minZoom : ctrl.panel.zoomLevel);\r\n        ctrl.$scope.mapContainer.options.maxZoom = (ctrl.panel.lockMap == 'No' ? ctrl.panel.maxZoom : ctrl.panel.zoomLevel);\r\n\r\n        ctrl.$scope.mapContainer.setZoom(ctrl.panel.zoomLevel);\r\n    }\r\n\r\n    updateMapView() {\r\n        var ctrl = this;\r\n\r\n        ctrl.$scope.mapContainer.fitBounds([\r\n            [ctrl.panel.maxLatitude, ctrl.panel.maxLongitude],\r\n            [ctrl.panel.minLatitude, ctrl.panel.minLongitude]\r\n        ]);\r\n    }\r\n\r\n    lockMap() {\r\n        var ctrl = this;\r\n\r\n        ctrl.$scope.mapContainer.remove();\r\n        ctrl.$scope.mapContainer = null;\r\n        ctrl.createMap();\r\n    }\r\n\r\n    boundToMarkers() {\r\n        var ctrl = this;\r\n\r\n        var markerGroup = new L.featureGroup(ctrl.circleMarkers);\r\n        if (markerGroup.getBounds().isValid())\r\n            ctrl.$scope.mapContainer.fitBounds(markerGroup.getBounds());\r\n\r\n        var bounds = ctrl.$scope.mapContainer.getBounds();\r\n        ctrl.panel.maxLongitude = bounds._southWest.lng;\r\n        ctrl.panel.maxLatitude = bounds._northEast.lat;\r\n        ctrl.panel.minLatitude = bounds._southWest.lat;\r\n        ctrl.panel.minLongitude = bounds._northEast.lng;\r\n    }\r\n    //#endregion\r\n\r\n    // #region Angular Tag Functions\r\n    getRange(min, max, step) {\r\n        step = step || 1;\r\n        var input = [];\r\n        for (var i = min; i <= max; i = i + step) {\r\n            input.push(i);\r\n        }\r\n        return input;\r\n    }\r\n    // #endregion\r\n\r\n    //#region Misc\r\n    createGeoJson(data) {\r\n        var ctrl = this;\r\n\r\n        var minLng = d3.min(data, function (a) { return a.longitude });\r\n        var minLat = d3.min(data, function (a) { return a.latitude  });\r\n        var maxLng = d3.max(data, function (a) { return a.longitude });\r\n        var maxLat = d3.max(data, function (a) { return a.latitude });\r\n\r\n        var overlapLat = (maxLat - minLat) * ctrl.panel.overlap/100;\r\n        var overlapLng = (maxLng - minLng) * ctrl.panel.overlap/100;\r\n\r\n        minLng -= overlapLng;\r\n        maxLng += overlapLng;\r\n        minLat -= overlapLat;\r\n        maxLat += overlapLat;\r\n\r\n        var gridN = ctrl.panel.xSteps;\r\n        var gridM = ctrl.panel.ySteps;\r\n        var pow = ctrl.panel.distancePower;\r\n\r\n        var nStep = Math.abs(maxLng - minLng) / gridN;\r\n        var mStep = Math.abs(maxLat - minLat) / gridM;\r\n\r\n        var breaks = [-9999999999];\r\n        var color = d3.scaleLinear()\r\n            .domain([ctrl.panel.gradientStart, ctrl.panel.gradientEnd])\r\n            .range([ctrl.panel.gradientStartColor, ctrl.panel.gradientEndColor])\r\n            .interpolate(d3.interpolateCubehelixLong);\r\n\r\n        var styles = [{\r\n            \"style\": {\r\n                \"stroke\": 0,\r\n                \"fillColor\": \"white\",\r\n                \"opacity\": 0\r\n            }\r\n        }];\r\n\r\n        for (var i = ctrl.panel.gradientStart; i <= ctrl.panel.gradientEnd; i+= (ctrl.panel.gradientEnd - ctrl.panel.gradientStart)/ctrl.panel.gradientBreakCount) {\r\n            breaks.push(i.toFixed(ctrl.panel.gradientSigFigs));\r\n            styles.push({\r\n                \"style\": {\r\n                    \"stroke\": 0,\r\n                    \"fillColor\": color(i)\r\n                }\r\n            })\r\n\r\n        }\r\n\r\n\r\n\r\n        var geoJson = {\r\n            \"type\": 'FeatureCollection',\r\n            \"properties\": {\r\n                \"breaks\": breaks,\r\n                \"breaksProperties\": styles,\r\n                \"zProperty\": \"Value\"\r\n            },\r\n            \"features\": []\r\n        }\r\n\r\n        for (var i = minLng - nStep; i <= maxLng + nStep; i += nStep) {\r\n            for (var j = minLat - mStep; j <= maxLat + mStep; j += mStep) {\r\n\r\n                var wzSum = 0;\r\n                var wSum = 0;\r\n                _.each(data, (element, index, list) => {\r\n                    var val = element.datapoints[element.datapoints.length - 1][0];\r\n                    if (isNaN(val))\r\n                        return;\r\n                    wzSum += val / Math.pow(ctrl.getDistanceFromLatLonInKm(element.latitude, element.longitude, j, i),pow);\r\n                    wSum += 1 / Math.pow(ctrl.getDistanceFromLatLonInKm(element.latitude, element.longitude, j, i),pow);\r\n                });\r\n\r\n                var value = wzSum/wSum;\r\n\r\n\r\n                if( i < minLng || i > maxLng || j < minLat || j > maxLat) value = -9999999999\r\n                var feature = {\r\n                    \"type\": \"Feature\",\r\n                    \"properties\": { Value: value},\r\n                    \"geometry\": {\r\n                        \"type\": \"Point\",\r\n                        \"coordinates\": [i, j]\r\n                    }\r\n                };\r\n\r\n                geoJson.features.push(feature)\r\n            }\r\n        }\r\n\r\n        return geoJson;\r\n    }\r\n\r\n    getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {\r\n        var ctrl = this;\r\n\r\n        var R = 6371; // Radius of the earth in km\r\n        var dLat = ctrl.deg2rad(lat2 - lat1);  // deg2rad below\r\n        var dLon = ctrl.deg2rad(lon2 - lon1);\r\n        var a =\r\n            Math.sin(dLat / 2) * Math.sin(dLat / 2) +\r\n            Math.cos(ctrl.deg2rad(lat1)) * Math.cos(ctrl.deg2rad(lat2)) *\r\n            Math.sin(dLon / 2) * Math.sin(dLon / 2)\r\n            ;\r\n        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n        var d = R * c; // Distance in km\r\n        return (d < 1 ? 1 : d);\r\n    }\r\n\r\n    deg2rad(deg) {\r\n        return deg * (Math.PI / 180)\r\n    }\r\n\r\n    project(x) {\r\n        var ctrl = this;\r\n        var point = ctrl.$scope.mapContainer.latLngToLayerPoint(new L.LatLng(x[1], x[0]));\r\n        return [point.x, point.y];\r\n    }\r\n    //#endregion\r\n\r\n}\r\n\r\nContourMapCtrl.templateUrl = 'partials/module.html';\r\n\r\n"]}